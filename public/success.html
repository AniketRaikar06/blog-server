<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sai Mahavir Foods | Success</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="style1.css">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://smtpjs.com/v3/smtp.js"></script>
</head>
<body>
    <section class="success">
      <img src="blocks/success.png">
      <h2><i class="fa fa-check" style="padding: 4px; color: green;border:2px solid green;font-size: 16px;border-radius: 50%; margin :0 5px;"></i>Your Order is Confirmed ! </h2>
      <p>We sent you a confirmation e-mail regarding this order,  please check your inbox or spam !</p>
      <div class="order_details"></div>
      <p>dont not refresh the page, you will be redirected , please wait if not  
        <br/> <a href="./index.html">click here</a>
      </p>
      <div id="message"></div>
    </section>  
    <!--<section class="failure">
      <img src="blocks/failure.png">
      <h2><i class="fa fa-close" style="padding: 4px; color: red;border:2px solid red;font-size: 16px;border-radius: 50%; margin :0 5px;"></i>Payment Failed ! </h2>
      <p>there is some issue with your payment, please try again later.</p>
      <div class="order_details"></div>
      <p>dont not refresh the page, you will be redirected , please wait if not  
        <br/> <a href="./index.html">click here</a>
      </p>
      <div id="message"></div>
    </section>-->

<script>
//config
var firebaseConfig = {
    apiKey: "AIzaSyCxYAhIWfApAoVuloS3zFMqIIM4ZM7XayI",
    authDomain: "sai-mahavir.firebaseapp.com",
    projectId: "sai-mahavir",
    storageBucket: "sai-mahavir.appspot.com",
    messagingSenderId: "310858203167",
    appId: "1:310858203167:web:3633e7f06d79e1da9cd52a",
    measurementId: "G-15HHZ18TKN"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const search = new URLSearchParams(window.location.search)
  const orderID_ = search.get("orderId");
  const name = search.get("name")
  const email = search.get("email")
  const total = search.get("total")
  const f = search.get("address")
  const date = search.get("date")
  const time = search.get("time")
  const userId = search.get("userId")
  const contact = search.get("contact")
  const gateway = search.get("gateway")

  // Initialize Stripe.js using your publishable key
//const stripe = Stripe('pk_live_51Kd95sSCaFy0it72Aavkg14GPhdg1cPUcL6psnbssDzOc48gRsjcbUTvWUxLV9rNX3HtYWc9R0F0f6xdckBA2F1000SmkmANj8');
var stripe = Stripe('pk_test_51Kd95sSCaFy0it72KN6cxNJAFeqt6lseAMslskVG0gOiSv0ovlVd0iU4yFEjerstt8EX3EFUrMqiaEcW2CC5xGYQ00CxC9au7q');
// Retrieve the "payment_intent_client_secret" query parameter appended to
// your return_url by Stripe.js
const clientSecret = new URLSearchParams(window.location.search).get(
  'payment_intent_client_secret'
);
if(gateway && gateway == 'stripe' && clientSecret !== ''){
  stripe.retrievePaymentIntent(clientSecret).then(({paymentIntent}) => {
  const message = document.querySelector('#message')

  // Inspect the PaymentIntent `status` to indicate the status of the payment
  // to your customer.
  //
  // Some payment methods will [immediately succeed or fail][0] upon
  // confirmation, while others will first enter a `processing` state.
  //
  // [0]: https://stripe.com/docs/payments/payment-methods#payment-notification
  if(paymentIntent){
    switch (paymentIntent.status) {
    case 'succeeded':
      message.innerText = 'Success! Payment received.';   
      console.log(paymentIntent)
      displaysuccesspayment()  
      saveorderinfo(paymentIntent) 
      break;

    case 'processing':
      message.innerText = "Payment processing. We'll update you when payment is received.";
      break;

    case 'requires_payment_method':
      message.innerText = 'Payment failed. Please try another payment method.';
      // Redirect your user back to your payment page to attempt collecting
      // payment again
      break;
    default:
      //document.getElementsByClassName('failure')[0].style.display = "none";
      message.innerText = 'Something went wrong.';
      break;
  }
  }
});
}
//const details = search.get("details")
var cc = JSON.parse(localStorage.getItem("details"));
function saveorderinfo(paymentIntent){  
        console.log(userId)
        if(cc !== null){
          var messagesRef1 = firebase.database().ref('order_details/orders/'+userId);
          var newMessageRef1 = messagesRef1.push()
          newMessageRef1.set({
            userID : userId,
            OrderID: orderID_,
            Customer : name,
            Email : email,
            Contact:contact,
            Recievers_details : f,
            Details: cc,
            Cart_items_names : [],
            Items :'',
            Quantity : '',
            Discount_value :'',
            Cart_total : total,
            PurchaseDate : date,
            PurchaseTime : time,
            Order_Status: 'Order Placed',
            gateway:gateway,
            paymentstatus:'success',
            paymentgatewaypaymentId:paymentIntent.id,
          });
          sendordercustomer(userId,name,email,f,cc,cc.length,total,date,time,orderID_,gateway,'success')
          localStorage.removeItem('details')
          setTimeout(() => {
            redirect()
          }, 5000);
        }else{
          alert('session expired')
          redirect()
        }
}

function sendordercustomer(orderID,reciever,email,f,carttitle,items,total,date,time,orderID_,gateway,paymentstatus){
  Email.send({
    //8ab08259-d5cc-4629-b55f-b8c0acbbcfed
    SecureToken:"2b31207e-bd6c-4c25-a041-73ca90b41fe9",
    To:`${email}`,
    // president.rca3141@gmail.com
    From:"saimahavirfoods@gmail.com",
    Subject: `Sai Mahavir Foods sent you a message - Succesfully Order Placed .`,
    Body:`<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
    <html>
      <head>
        <!-- Compiled with Bootstrap Email version: 1.3.1 --><meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="x-apple-disable-message-reformatting">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="format-detection" content="telephone=no, date=no, address=no, email=no">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <style type="text/css">
          body,table,td{font-family:Helvetica,Arial,sans-serif !important}.ExternalClass{width:100%}.ExternalClass,.ExternalClass p,.ExternalClass span,.ExternalClass font,.ExternalClass td,.ExternalClass div{line-height:150%}a{text-decoration:none}*{color:inherit}a[x-apple-data-detectors],u+#body a,#MessageViewBody a{color:inherit;text-decoration:none;font-size:inherit;font-family:inherit;font-weight:inherit;line-height:inherit}img{-ms-interpolation-mode:bicubic}table:not([class^=s-]){font-family:Helvetica,Arial,sans-serif;mso-table-lspace:0pt;mso-table-rspace:0pt;border-spacing:0px;border-collapse:collapse}table:not([class^=s-]) td{border-spacing:0px;border-collapse:collapse}@media screen and (max-width: 600px){.w-lg-48,.w-lg-48>tbody>tr>td{width:auto !important}.w-full,.w-full>tbody>tr>td{width:100% !important}.w-16,.w-16>tbody>tr>td{width:64px !important}.p-lg-10:not(table),.p-lg-10:not(.btn)>tbody>tr>td,.p-lg-10.btn td a{padding:0 !important}.p-2:not(table),.p-2:not(.btn)>tbody>tr>td,.p-2.btn td a{padding:8px !important}.pr-4:not(table),.pr-4:not(.btn)>tbody>tr>td,.pr-4.btn td a,.px-4:not(table),.px-4:not(.btn)>tbody>tr>td,.px-4.btn td a{padding-right:16px !important}.pl-4:not(table),.pl-4:not(.btn)>tbody>tr>td,.pl-4.btn td a,.px-4:not(table),.px-4:not(.btn)>tbody>tr>td,.px-4.btn td a{padding-left:16px !important}.pr-6:not(table),.pr-6:not(.btn)>tbody>tr>td,.pr-6.btn td a,.px-6:not(table),.px-6:not(.btn)>tbody>tr>td,.px-6.btn td a{padding-right:24px !important}.pl-6:not(table),.pl-6:not(.btn)>tbody>tr>td,.pl-6.btn td a,.px-6:not(table),.px-6:not(.btn)>tbody>tr>td,.px-6.btn td a{padding-left:24px !important}.pt-8:not(table),.pt-8:not(.btn)>tbody>tr>td,.pt-8.btn td a,.py-8:not(table),.py-8:not(.btn)>tbody>tr>td,.py-8.btn td a{padding-top:32px !important}.pb-8:not(table),.pb-8:not(.btn)>tbody>tr>td,.pb-8.btn td a,.py-8:not(table),.py-8:not(.btn)>tbody>tr>td,.py-8.btn td a{padding-bottom:32px !important}*[class*=s-lg-]>tbody>tr>td{font-size:0 !important;line-height:0 !important;height:0 !important}.s-4>tbody>tr>td{font-size:16px !important;line-height:16px !important;height:16px !important}.s-6>tbody>tr>td{font-size:24px !important;line-height:24px !important;height:24px !important}}
        </style>
      </head>
      <body class="bg-100" style="outline: 0; width: 100%; min-width: 100%; height: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; font-family: Helvetica, Arial, sans-serif; line-height: 24px; font-weight: normal; font-size: 16px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; color: #000000; margin: 0; padding: 0; border-width: 0;" bgcolor="#ffffff">
        <table class="bg-100 body" valign="top" role="presentation" border="0" cellpadding="0" cellspacing="0" style="outline: 0; width: 100%; min-width: 100%; height: 100%; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; font-family: Helvetica, Arial, sans-serif; line-height: 24px; font-weight: normal; font-size: 16px; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; color: #000000; margin: 0; padding: 0; border-width: 0;" bgcolor="#ffffff">
          <tbody>
            <tr>
              <td valign="top" style="line-height: 24px; font-size: 16px; margin: 0;" align="left">
                <table class="container" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
                  <tbody>
                    <tr>
                      <td align="center" style="line-height: 24px; font-size: 16px; margin: 0; padding: 0 16px;">
                        <!--[if (gte mso 9)|(IE)]>
                          <table align="center" role="presentation">
                            <tbody>
                              <tr>
                                <td width="600">
                        <![endif]-->
                        <table align="center" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%; max-width: 600px; margin: 0 auto;">
                          <tbody>
                            <tr>
                              <td style="line-height: 24px; font-size: 16px; margin: 0;" align="left">
                                <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                  <tbody>
                                    <tr>
                                      <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                        &#160;
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                <img class="w-16" src="https://ik.imagekit.io/bk4vkk0xf/saimahavir/logos.jpeg" style="height: auto; line-height: 100%; outline: none; text-decoration: none; display: block; width: 64px; border-style: none; border-width: 0;" width="64">
                                <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                  <tbody>
                                    <tr>
                                      <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                        &#160;
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                <div class="space-y-4">
                                  <h1 class="text-4xl fw-800" style="padding-top: 0; padding-bottom: 0; font-weight: 800 !important; vertical-align: baseline; font-size: 36px; line-height: 43.2px; margin: 0;" align="left">Thanks for your order, ${reciever}</h1>
                                  <table class="s-4 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                    <tbody>
                                      <tr>
                                        <td style="line-height: 16px; font-size: 16px; width: 100%; height: 16px; margin: 0;" align="left" width="100%" height="16">
                                          &#160;
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                  <p class="" style="line-height: 24px; font-size: 16px; width: 100%; margin: 0;" align="left">Your order for ${items} Items hasn't shipped yet, but we will send you an email when it does. Track your order on the saimahavir website.</p>
                                  <table class="s-4 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                    <tbody>
                                      <tr>
                                        <td style="line-height: 16px; font-size: 16px; width: 100%; height: 16px; margin: 0;" align="left" width="100%" height="16">
                                          &#160;
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                  <table class="btn btn-red-500 rounded-full px-6 w-full w-lg-48" role="presentation" border="0" cellpadding="0" cellspacing="0" style="border-radius: 9999px; border-collapse: separate !important; width: 192px;" width="192">
                                    <tbody>
                                      <tr>
                                        <td style="line-height: 24px; font-size: 16px; border-radius: 9999px; width: 192px; margin: 0;" align="center" bgcolor="#dc3545" width="192">
                                          <a href="https://www.saimahavir.in/" style="color: #ffffff; font-size: 16px; font-family: Helvetica, Arial, sans-serif; text-decoration: none; border-radius: 9999px; line-height: 20px; display: block; font-weight: normal; white-space: nowrap; background-color: #dc3545; padding: 8px 24px; border: 1px solid #dc3545;">Track Your Order</a>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                  <tbody>
                                    <tr>
                                      <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                        &#160;
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                <table class="card rounded-3xl px-4 py-8 p-lg-10" role="presentation" border="0" cellpadding="0" cellspacing="0" style="border-radius: 24px; border-collapse: separate !important; width: 100%; overflow: hidden; border: 1px solid #e2e8f0;" bgcolor="#ffffff">
                                  <tbody>
                                    <tr>
                                      <td style="line-height: 24px; font-size: 16px; width: 100%; border-radius: 24px; margin: 0; padding: 40px;" align="left" bgcolor="#ffffff">
                                        <h3 class="text-center" style="padding-top: 0; padding-bottom: 0; font-weight: 500; vertical-align: baseline; font-size: 28px; line-height: 33.6px; margin: 0;" align="center">Receipt from Sai Mahavir Foods</h3>
                                        <p class="text-center text-muted" style="line-height: 24px; font-size: 16px; color: #718096; width: 100%; margin: 0;" align="center">ORDER-ID ${orderID_}</p>
                                        <table class="p-2 w-full" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                          <tbody>
                                          ${carttitle.map(x=>{
                                            return  `
                                            <tr>
                                              <td style="line-height: 24px; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="left" width="100%">${x.title}</td>
                                              <td class="text-right" style="line-height: 24px; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="right" width="100%">${x.quantity}</td>
                                              <td class="text-right" style="line-height: 24px; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="right" width="100%">&#8377;${x.price}</td>
                                            </tr>`
                                          }).join('')}
                                          <tr>
                                            <td style="line-height: 24px;font-weight:bold; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="left" width="100%">Amount Paid</td>
                                            <td class="text-right" style="line-height: 24px;font-weight:bold; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="right" width="100%">${items}</td>
                                            <td class="text-right" style="line-height: 24px;font-weight:bold; font-size: 16px; width: 100%; margin: 0; padding: 8px;" align="right" width="100%">&#8377;${total/100}</td>
                                          </tr>
                                          </tbody>
                                        </table>
                                        <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                          <tbody>
                                            <tr>
                                              <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                                &#160;
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <table class="hr" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
                                          <tbody>
                                            <tr>
                                              <td style="line-height: 24px; font-size: 16px; border-top-width: 1px; border-top-color: #e2e8f0; border-top-style: solid; height: 1px; width: 100%; margin: 0;" align="left">
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                          <tbody>
                                            <tr>
                                              <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                                &#160;
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <p style="line-height: 24px; font-size: 16px; width: 100%; margin: 0;" align="left">Ship To,<br/>
                                        ${f}</p>
                                        <p style="line-height: 24px; font-size: 16px; width: 100%; margin: 0;" align="left">
                                        Payment: ${gateway}
                                        status: ${paymentstatus}
                                        </p>
                                        <br/>
                                        <p style="line-height: 24px; font-size: 16px; width: 100%; margin: 0;" align="left">If you have any questions, contact us at <a href="https://bootstrapemail.com" style="color: #0d6efd;">saimahavirfoods@gmail.com</a>.</p>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                                <table class="s-6 w-full" role="presentation" border="0" cellpadding="0" cellspacing="0" style="width: 100%;" width="100%">
                                  <tbody>
                                    <tr>
                                      <td style="line-height: 24px; font-size: 24px; width: 100%; height: 24px; margin: 0;" align="left" width="100%" height="24">
                                        &#160;
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <!--[if (gte mso 9)|(IE)]>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                        <![endif]-->
                      </td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
      </body>
    </html>`  
  }).then( (message) => console.log(message))
}
function redirect(){
  location.replace('/index.html')
}

function displaysuccesspayment(){
        document.getElementsByClassName('success')[0].style.display = "block";
        var cartaddress1 = document.createElement('div')
            var qw1 = document.getElementsByClassName('order_details')[0];
            var address1 = ` <div class="address">
            <span class="rec"> Order ID : ${orderID_}</span><br>
            <span class="rec"> Name : ${name}</span><br>
            <span class="rec"> Email : ${email}</span><br>
            <span class="rec"> Total : ${total/100} Rs.</span><br><br>
            <span class="rec"> Address : ${f}</span><br><br>
            <span class="rec"> Time :  ${date} ${time}</span>
          </div>`
              cartaddress1.innerHTML = address1 
              qw1.append(cartaddress1)
}

</script>
</body>
</html>